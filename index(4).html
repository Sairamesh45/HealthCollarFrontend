<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyPerro ‚Äî Collar Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root{--bg:#0a0a0f;--surface:#111118;--surface2:#1a1a24;--border:#2a2a38;--accent:#7c6dfa;--accent2:#fa6d8a;--accent3:#6dfacc;--text:#e8e8f0;--muted:#6b6b80;--warn:#facc6d;}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(124,109,250,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(124,109,250,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}
  .app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:32px 24px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:48px;}
  .logo{display:flex;align-items:center;gap:12px;}
  .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;}
  .logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px;}
  .logo-text span{color:var(--accent);}
  .status-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:999px;padding:6px 14px;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);}
  .status-dot{width:7px;height:7px;border-radius:50%;background:var(--accent3);box-shadow:0 0 8px var(--accent3);animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .collar-tabs{display:flex;gap:8px;margin-bottom:32px;}
  .collar-tab{flex:1;padding:14px 20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;gap:4px;}
  .collar-tab:hover{border-color:var(--accent);background:var(--surface2);}
  .collar-tab.active{border-color:var(--accent);background:var(--surface2);box-shadow:0 0 24px rgba(124,109,250,0.12);}
  .tab-name{font-size:14px;font-weight:700;}
  .tab-status{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);}
  .tab-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:5px;background:var(--muted);}
  .collar-tab.online .tab-dot{background:var(--accent3);box-shadow:0 0 6px var(--accent3);}
  .collar-tab.offline-tab .tab-dot{background:var(--accent2);}
  .panel{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all 0.2s;}
  .card.offline-card{border-color:rgba(250,109,138,0.3);background:rgba(250,109,138,0.04);}
  .card-label{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
  .offline-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(250,109,138,0.12);border:1px solid rgba(250,109,138,0.3);border-radius:999px;padding:2px 8px;font-size:10px;color:var(--accent2);}
  .card-value{font-size:52px;font-weight:800;letter-spacing:-2px;line-height:1;background:linear-gradient(135deg,var(--text),var(--muted));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .card-value.accent{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .card-value.dim{background:linear-gradient(135deg,var(--muted),#444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .card-unit{font-size:16px;font-weight:400;opacity:.6;margin-left:4px;-webkit-text-fill-color:var(--muted);}
  .card-sub{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:8px;}
  .refresh-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
  .refresh-right{display:flex;align-items:center;gap:10px;}
  .last-updated{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);}
  .btn-sm{border-radius:8px;padding:7px 14px;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:all 0.2s;}
  .btn-ghost{background:var(--surface2);border:1px solid var(--border);color:var(--muted);}
  .btn-ghost:hover{border-color:var(--accent);color:var(--text);}
  .btn-danger{background:rgba(250,109,138,0.08);border:1px solid rgba(250,109,138,0.25);color:var(--accent2);}
  .btn-danger:hover{background:rgba(250,109,138,0.15);border-color:var(--accent2);}
  .btn-sm:disabled{opacity:.5;cursor:not-allowed;}
  .config-section{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;}
  .config-title{font-size:16px;font-weight:700;margin-bottom:4px;}
  .config-subtitle{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-bottom:24px;}
  .config-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
  .field{display:flex;flex-direction:column;gap:6px;}
  .field label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;}
  .field-hint{font-size:10px;color:var(--muted);opacity:.55;line-height:1.4;}
  input[type="number"]{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s;-moz-appearance:textfield;}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;}
  input[type="number"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,109,250,.12);}
  .btn-primary{margin-top:24px;width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
  .btn-primary::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);opacity:0;transition:opacity .2s;}
  .btn-primary:hover::before{opacity:1;}
  .btn-primary:active{transform:scale(.98);}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed;}
  .toast{position:fixed;bottom:32px;right:32px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 20px;font-family:'DM Mono',monospace;font-size:13px;transform:translateY(80px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);z-index:100;max-width:380px;}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.success{border-color:var(--accent3);}
  .toast.error{border-color:var(--accent2);}
  .toast.warn{border-color:var(--warn);}
  .skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px;height:52px;width:120px;display:inline-block;}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  @media(max-width:700px){.panel,.config-grid-4{grid-template-columns:1fr 1fr;}.collar-tabs{flex-direction:column;}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">üêæ</div>
      <div class="logo-text">my<span>perro</span></div>
    </div>
    <div class="status-pill">
      <span class="status-dot" id="connDot"></span>
      <span id="connLabel">connecting...</span>
    </div>
  </header>

  <div class="collar-tabs" id="collarTabs"></div>

  <div class="refresh-row">
    <span class="last-updated" id="lastUpdated">‚Äî</span>
    <div class="refresh-right">
      <button class="btn-sm btn-danger" id="resetBtn" onclick="resetCollar()">‚úï reset to 0</button>
      <button class="btn-sm btn-ghost" onclick="refreshData()">‚Üª refresh</button>
    </div>
  </div>

  <div class="panel">
    <div class="card" id="stepsCard">
      <div class="card-label">
        Total Steps
        <span class="offline-badge" id="offlineBadge" style="display:none">‚óè offline</span>
      </div>
      <div class="card-value accent" id="metricSteps"><span class="skeleton"></span></div>
      <div class="card-sub" id="metricStepsSub">loading...</div>
    </div>
    <div class="card" id="tempCard">
      <div class="card-label">Temperature</div>
      <div class="card-value" id="metricTemp"><span class="skeleton"></span></div>
      <div class="card-sub" id="metricTempSub">loading...</div>
    </div>
  </div>

  <div class="config-section">
    <div class="config-title">Algorithm Config</div>
    <div class="config-subtitle">Changes push instantly to collar via ThingsBoard MQTT</div>
    <div class="config-grid-4">
      <div class="field">
        <label>Peak Threshold</label>
        <div class="field-hint">Min accel to count as peak</div>
        <input type="number" id="cfgPeakThreshold" value="11.3" min="1" max="50" step="0.1"/>
      </div>
      <div class="field">
        <label>Peak Window N</label>
        <div class="field-hint">Samples each side of peak</div>
        <input type="number" id="cfgPeakWindowN" value="4" min="1" max="10" step="1"/>
      </div>
      <div class="field">
        <label>Filter Window</label>
        <div class="field-hint">Moving avg smoothing size</div>
        <input type="number" id="cfgFilterWindow" value="5" min="1" max="20" step="1"/>
      </div>
      <div class="field">
        <label>Emissivity</label>
        <div class="field-hint">MLX90614 surface (0.1‚Äì1.0)</div>
        <input type="number" id="cfgEmissivity" value="0.95" min="0.1" max="1.0" step="0.01"/>
      </div>
    </div>
    <button class="btn-primary" id="saveBtn" onclick="saveConfig()">Push Config to Collar</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const TB_HOST="https://thingsboard.cloud",TB_USER="shriansh1510@gmail.com",TB_PASS="Achaokay1!",OFFLINE_TIMEOUT=30000;
const COLLARS=[{name:"Collar 1",deviceId:"8ffcb860-141c-11f1-ad13-23db93f4d850"},{name:"Collar 2",deviceId:"bc1cde30-1425-11f1-ad13-23db93f4d850"},{name:"Collar 3",deviceId:"cf525160-1425-11f1-9033-1744e78c8f53"}];
let jwtToken=null,tokenExpiry=0,activeCollar=0;
let collarStatus=COLLARS.map(()=>({tsMs:null,isOnline:false,steps:null,temp:null}));
let offlineResetDone=[false,false,false];

async function getToken(){
  if(jwtToken&&Date.now()<tokenExpiry-60000)return jwtToken;
  const r=await fetch(`${TB_HOST}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:TB_USER,password:TB_PASS})});
  if(!r.ok)throw new Error("Auth failed: "+r.status);
  const d=await r.json();jwtToken=d.token;tokenExpiry=Date.now()+3600000;return jwtToken;
}
async function getTelemetry(id){
  const t=await getToken();
  const r=await fetch(`${TB_HOST}/api/plugins/telemetry/DEVICE/${id}/values/timeseries?keys=steps,temperature`,{headers:{"X-Authorization":"Bearer "+t}});
  if(!r.ok)throw new Error("Telemetry "+r.status);return r.json();
}
async function pushZero(id){
  const t=await getToken();
  const r=await fetch(`${TB_HOST}/api/plugins/telemetry/DEVICE/${id}/timeseries/ANY`,{method:"POST",headers:{"X-Authorization":"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify({steps:0,temperature:0})});
  return r.ok||r.status===204;
}
async function getAttrs(id){
  const t=await getToken();
  const r=await fetch(`${TB_HOST}/api/plugins/telemetry/DEVICE/${id}/values/attributes/SHARED_SCOPE`,{headers:{"X-Authorization":"Bearer "+t}});
  if(!r.ok)return{};const a=await r.json();const o={};a.forEach(x=>o[x.key]=x.value);return o;
}
async function setAttrs(id,attrs){
  const t=await getToken();
  const r=await fetch(`${TB_HOST}/api/plugins/telemetry/DEVICE/${id}/attributes/SHARED_SCOPE`,{method:"POST",headers:{"X-Authorization":"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(attrs)});
  if(!r.ok)throw new Error("Attr set failed: "+r.status);
}

async function handleOffline(i){
  if(offlineResetDone[i])return;offlineResetDone[i]=true;
  try{await pushZero(COLLARS[i].deviceId);showToast(`‚ö† ${COLLARS[i].name} offline ‚Äî values reset to 0`,"warn");if(i===activeCollar)renderMetrics(i);}catch(e){}
}
async function resetCollar(){
  const btn=document.getElementById("resetBtn");btn.disabled=true;btn.textContent="resetting...";
  try{await pushZero(COLLARS[activeCollar].deviceId);offlineResetDone[activeCollar]=true;collarStatus[activeCollar].steps=0;collarStatus[activeCollar].temp=0;renderMetrics(activeCollar);showToast(`‚úì ${COLLARS[activeCollar].name} reset to 0`,"success");}
  catch(e){showToast("‚úó Reset failed: "+e.message,"error");}
  finally{btn.disabled=false;btn.textContent="‚úï reset to 0";}
}

async function refreshData(){
  const collar=COLLARS[activeCollar];
  try{
    const[telem,attrs]=await Promise.all([getTelemetry(collar.deviceId),getAttrs(collar.deviceId)]);
    const steps=telem.steps?.[0]?.value??null,temp=telem.temperature?.[0]?.value??null;
    const tsMs=telem.steps?.[0]?.ts||telem.temperature?.[0]?.ts||null;
    const isOnline=tsMs&&(Date.now()-tsMs)<OFFLINE_TIMEOUT;
    collarStatus[activeCollar]={steps,temp,tsMs,isOnline};
    if(tsMs&&!isOnline)handleOffline(activeCollar);
    if(isOnline)offlineResetDone[activeCollar]=false;
    renderMetrics(activeCollar);populateConfig(attrs);updateTabStatus();
    document.getElementById("connDot").style.cssText="background:var(--accent3);box-shadow:0 0 8px var(--accent3);";
    document.getElementById("connLabel").textContent="connected";
    document.getElementById("lastUpdated").textContent="refreshed "+new Date().toLocaleTimeString();
  }catch(e){
    document.getElementById("connDot").style.cssText="background:var(--accent2);box-shadow:0 0 8px var(--accent2);";
    document.getElementById("connLabel").textContent="error";showToast("‚ö† "+e.message,"error");
  }
}

function renderMetrics(i){
  if(i!==activeCollar)return;
  const{steps,temp,tsMs,isOnline}=collarStatus[i];
  const se=document.getElementById("metricSteps"),te=document.getElementById("metricTemp");
  const sc=document.getElementById("stepsCard"),tc=document.getElementById("tempCard"),b=document.getElementById("offlineBadge");
  if(isOnline){sc.classList.remove("offline-card");tc.classList.remove("offline-card");b.style.display="none";se.className="card-value accent";}
  else if(tsMs){sc.classList.add("offline-card");tc.classList.add("offline-card");b.style.display="inline-flex";se.className="card-value dim";}
  se.innerHTML=steps!==null?Number(steps).toLocaleString():`<span style="font-size:24px;opacity:.4">no data</span>`;
  te.innerHTML=temp!==null?`${parseFloat(temp).toFixed(1)}<span class="card-unit">¬∞C</span>`:`<span style="font-size:24px;opacity:.4">no data</span>`;
  const ago=tsMs?timeAgo(tsMs):null;
  document.getElementById("metricStepsSub").textContent=tsMs?(isOnline?`updated ${ago}`:`last seen ${ago} ‚Äî offline`):"waiting for device...";
  document.getElementById("metricTempSub").textContent=tsMs?(isOnline?`updated ${ago}`:`last seen ${ago}`):"waiting for device...";
}

function populateConfig(a){
  if(!a)return;
  if(a.peak_threshold!=null)document.getElementById("cfgPeakThreshold").value=a.peak_threshold;
  if(a.peak_window_n!=null)document.getElementById("cfgPeakWindowN").value=a.peak_window_n;
  if(a.filter_window_size!=null)document.getElementById("cfgFilterWindow").value=a.filter_window_size;
  if(a.emissivity!=null)document.getElementById("cfgEmissivity").value=a.emissivity;
}

async function saveConfig(){
  const pt=parseFloat(document.getElementById("cfgPeakThreshold").value);
  const pwn=parseInt(document.getElementById("cfgPeakWindowN").value);
  const fw=parseInt(document.getElementById("cfgFilterWindow").value);
  const em=parseFloat(document.getElementById("cfgEmissivity").value);
  if(isNaN(pt)||pt<1||pt>50){showToast("‚úó Peak threshold: enter 1‚Äì50","error");return;}
  if(isNaN(pwn)||pwn<1||pwn>10){showToast("‚úó Peak window N: enter 1‚Äì10","error");return;}
  if(isNaN(fw)||fw<1||fw>20){showToast("‚úó Filter window: enter 1‚Äì20","error");return;}
  if(isNaN(em)||em<0.1||em>1){showToast("‚úó Emissivity: enter 0.10‚Äì1.00","error");return;}
  const btn=document.getElementById("saveBtn");btn.disabled=true;btn.textContent="Pushing...";
  try{await setAttrs(COLLARS[activeCollar].deviceId,{peak_threshold:pt,peak_window_n:pwn,filter_window_size:fw,emissivity:em});showToast("‚úì Config pushed to "+COLLARS[activeCollar].name,"success");}
  catch(e){showToast("‚úó "+e.message,"error");}
  finally{btn.disabled=false;btn.textContent="Push Config to Collar";}
}

function buildTabs(){
  const c=document.getElementById("collarTabs");c.innerHTML="";
  COLLARS.forEach((collar,i)=>{
    const s=collarStatus[i];
    const tab=document.createElement("div");
    tab.className="collar-tab"+(i===activeCollar?" active":"")+(s.isOnline?" online":"")+((!s.isOnline&&s.tsMs)?" offline-tab":"");
    tab.innerHTML=`<div class="tab-name">${collar.name}</div><div class="tab-status"><span class="tab-dot"></span><span>${s.tsMs?(s.isOnline?"online":"offline"):"‚Äî"}</span></div>`;
    tab.onclick=()=>selectCollar(i);c.appendChild(tab);
  });
}

function selectCollar(i){
  activeCollar=i;buildTabs();
  document.getElementById("metricSteps").innerHTML='<span class="skeleton"></span>';
  document.getElementById("metricTemp").innerHTML='<span class="skeleton"></span>';
  document.getElementById("metricStepsSub").textContent="loading...";
  document.getElementById("metricTempSub").textContent="loading...";
  document.getElementById("offlineBadge").style.display="none";
  document.getElementById("stepsCard").classList.remove("offline-card");
  document.getElementById("tempCard").classList.remove("offline-card");
  refreshData();
}

function updateTabStatus(){buildTabs();}

async function pollAllCollars(){
  for(let i=0;i<COLLARS.length;i++){
    if(i===activeCollar)continue;
    try{
      const telem=await getTelemetry(COLLARS[i].deviceId);
      const tsMs=telem.steps?.[0]?.ts||telem.temperature?.[0]?.ts||null;
      const isOnline=tsMs&&(Date.now()-tsMs)<OFFLINE_TIMEOUT;
      collarStatus[i]={steps:telem.steps?.[0]?.value??null,temp:telem.temperature?.[0]?.value??null,tsMs,isOnline};
      if(tsMs&&!isOnline)handleOffline(i);if(isOnline)offlineResetDone[i]=false;
    }catch(e){}
  }updateTabStatus();
}

function timeAgo(ts){const s=Math.floor((Date.now()-ts)/1000);if(s<5)return"just now";if(s<60)return s+"s ago";if(s<3600)return Math.floor(s/60)+"m ago";return Math.floor(s/3600)+"h ago";}
function showToast(msg,type){const t=document.getElementById("toast");t.textContent=msg;t.className="toast "+(type||"");t.classList.add("show");clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove("show"),3800);}

buildTabs();refreshData();
setInterval(refreshData,10000);
setInterval(pollAllCollars,15000);
</script>
</body>
</html>
