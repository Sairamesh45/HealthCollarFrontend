<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyPerro â€” Health Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DESIGN TOKENS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --brand:        #F97316;
  --brand-dark:   #EA6C0A;
  --brand-pale:   #FFF1E6;
  --brand-mid:    #FED7AA;
  --teal:         #14B8A6;
  --teal-pale:    #CCFBF1;
  --teal-dark:    #0F9286;
  --bg:           #FFF7ED;
  --bg2:          #FEF3E2;
  --bg3:          #FDEBD0;
  --card:         #FFFFFF;
  --border:       #E2E8F0;
  --border2:      #CBD5E1;
  --text:         #1E293B;
  --text2:        #475569;
  --muted:        #64748B;
  --muted2:       #94A3B8;
  --success:      #16A34A;
  --success-pale: #DCFCE7;
  --danger:       #DC2626;
  --danger-pale:  #FEE2E2;
  --warn:         #D97706;
  --warn-pale:    #FEF3C7;
  --shadow-xs:    0 1px 2px rgba(0,0,0,.05);
  --shadow-sm:    0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
  --shadow:       0 4px 12px rgba(0,0,0,.09), 0 2px 4px rgba(0,0,0,.04);
  --shadow-lg:    0 10px 30px rgba(0,0,0,.10), 0 4px 10px rgba(0,0,0,.05);
  --r:            16px;
  --r-sm:         10px;
  --r-pill:       999px;
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.navbar {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow-xs);
}

.nav-inner {
  max-width: 1160px;
  margin: 0 auto;
  padding: 0 24px;
  height: 64px;
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Logo */
.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  text-decoration: none;
  color: inherit;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(140deg, #FF8C3A, #F97316);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(249,115,22,.4);
  flex-shrink: 0;
  user-select: none;
}

.logo-name {
  font-size: 19px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text);
  line-height: 1;
  white-space: nowrap;
}

.logo-name em { color: var(--brand); font-style: normal; }

/* Pill selector */
.pill-bar {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r-pill);
  padding: 4px;
  margin: 0 auto;
}

.c-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: var(--r-pill);
  cursor: pointer;
  transition: all 0.16s ease;
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  border: 1px solid transparent;
  white-space: nowrap;
  user-select: none;
  line-height: 1;
}

.c-pill:hover { color: var(--text2); background: rgba(255,255,255,.65); }

.c-pill.active {
  background: var(--card);
  color: var(--brand);
  border-color: rgba(249,115,22,.2);
  font-weight: 600;
  box-shadow: var(--shadow-sm);
}

.pill-emo { font-size: 14px; }

.pill-led {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--muted2);
  flex-shrink: 0;
  transition: background .2s;
}

.c-pill.online-pill .pill-led {
  background: var(--success);
  animation: breathe 2.4s ease-in-out infinite;
}

@keyframes breathe {
  0%,100% { box-shadow: 0 0 0 0 rgba(22,163,74,.5); }
  50%      { box-shadow: 0 0 0 4px rgba(22,163,74,.1); }
}

.c-pill.offline-pill .pill-led { background: var(--danger); }

/* Navbar right */
.nav-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.conn-pill {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 6px 13px;
  border-radius: var(--r-pill);
  font-size: 12px;
  font-weight: 500;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--muted);
  transition: all .2s;
}

.conn-led {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--muted2);
  transition: all .2s;
}

.conn-led.online  { background: var(--success); animation: breathe 2.4s infinite; }
.conn-led.error   { background: var(--danger); }
.conn-led.connecting { background: var(--warn); animation: breathe 1.2s infinite; }

/* â”€â”€ PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page {
  max-width: 1160px;
  margin: 0 auto;
  padding: 28px 24px 80px;
}

/* Mobile scrollable Collar strip */
.mobile-collars {
  display: none;
  overflow-x: auto;
  gap: 8px;
  padding: 4px 0 12px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  margin-bottom: 16px;
}
.mobile-collars::-webkit-scrollbar { display: none; }

/* â”€â”€ PET HERO BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pet-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 22px;
  gap: 12px;
  flex-wrap: wrap;
}

.pet-id {
  display: flex;
  align-items: center;
  gap: 14px;
}

.pet-avi {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--brand-pale), var(--brand-mid));
  border: 2.5px solid var(--brand-mid);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  flex-shrink: 0;
  box-shadow: var(--shadow-sm);
  transition: transform .2s;
}

.pet-avi:hover { transform: scale(1.06); }

.pet-name {
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -.5px;
  line-height: 1.1;
}

.pet-meta {
  font-size: 13px;
  color: var(--muted);
  margin-top: 3px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.status-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 600;
  padding: 2px 9px;
  border-radius: var(--r-pill);
}

.status-tag.online  { color: var(--success); background: var(--success-pale); }
.status-tag.offline { color: var(--danger);  background: var(--danger-pale);  }

.pet-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.sync-label {
  font-size: 12px;
  color: var(--muted);
  padding: 6px 12px;
  background: var(--card);
  border-radius: var(--r-pill);
  border: 1px solid var(--border);
}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: var(--r-sm);
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .16s;
  border: 1px solid transparent;
  line-height: 1;
  white-space: nowrap;
}

.btn:disabled { opacity: .45; cursor: not-allowed; pointer-events: none; }

.btn-outline {
  background: var(--card);
  border-color: var(--border);
  color: var(--text2);
}
.btn-outline:hover {
  border-color: var(--brand);
  color: var(--brand);
  background: var(--brand-pale);
  box-shadow: var(--shadow-xs);
}

.btn-reset {
  background: var(--card);
  border-color: var(--border);
  color: var(--muted);
}
.btn-reset:hover {
  border-color: #FECACA;
  background: var(--danger-pale);
  color: var(--danger);
}

.btn-primary {
  background: linear-gradient(135deg, var(--brand), #FB923C);
  color: white;
  border: none;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(249,115,22,.35);
  position: relative;
  overflow: hidden;
}
.btn-primary::after {
  content:'';
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.12);
  opacity:0;
  transition:opacity .16s;
}
.btn-primary:hover {
  background: linear-gradient(135deg, var(--brand-dark), var(--brand));
  box-shadow: 0 4px 16px rgba(249,115,22,.4);
  transform: translateY(-1px);
}
.btn-primary:hover::after { opacity:1; }
.btn-primary:active { transform:scale(.99); }
.btn-primary.full { width:100%; justify-content:center; padding:13px; font-size:14px; }
.btn-primary:disabled { opacity:.45; cursor:not-allowed; pointer-events:none; transform:none; box-shadow:none; }

/* â”€â”€ METRICS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 18px;
}

.m-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px 22px 22px;
  box-shadow: var(--shadow-sm);
  transition: box-shadow .2s, transform .2s, border-color .2s;
  cursor: default;
  position: relative;
  overflow: hidden;
}

.m-card:hover {
  box-shadow: var(--shadow);
  transform: translateY(-2px);
  border-color: var(--border2);
}

.m-card::after {
  content:'';
  position:absolute;
  bottom:0; left:0; right:0;
  height:3px;
  border-radius:0 0 var(--r) var(--r);
  background: var(--brand);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform .22s ease;
}

.m-card:hover::after { transform:scaleX(1); }
.m-card.teal-line::after { background: var(--teal); }

.m-card.offline-card {
  border-color: #FECACA;
  background: linear-gradient(145deg, #fff, #FFFAFA);
}

.m-icon-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.m-icon {
  width: 40px;
  height: 40px;
  border-radius: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 19px;
  flex-shrink: 0;
}

.m-icon.orange { background: var(--brand-pale); }
.m-icon.teal   { background: var(--teal-pale); }
.m-icon.slate  { background: #F1F5F9; }
.m-icon.warm   { background: var(--bg3); }

.offline-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--danger-pale);
  color: var(--danger);
  border-radius: var(--r-pill);
  padding: 3px 9px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .02em;
}

.m-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .05em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 7px;
}

.m-value {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: -1.5px;
  line-height: 1;
  color: var(--text);
  min-height: 36px;
}

.m-value.brand  { color: var(--brand); }
.m-value.teal   { color: var(--teal);  }
.m-value.muted  { color: var(--muted); }
.m-value.sm     { font-size: 24px; letter-spacing: -.5px; }

.m-unit {
  font-size: 17px;
  font-weight: 500;
  color: var(--muted);
  letter-spacing: 0;
}

.m-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 9px;
  line-height: 1.4;
}

/* â”€â”€ SKELETON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skel {
  display: inline-block;
  height: 36px;
  width: 96px;
  border-radius: 8px;
  background: linear-gradient(90deg, #F1F5F9 25%, #E2E8F0 50%, #F1F5F9 75%);
  background-size: 200% 100%;
  animation: shimmer 1.4s infinite;
  vertical-align: middle;
}

.skel.sm { height: 14px; width: 80px; border-radius: 4px; }
.skel.ls { height: 28px; width: 100px; border-radius: 6px; }

@keyframes shimmer { 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 } }

/* â”€â”€ SECTION HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec-hdr {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.sec-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.sec-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: var(--teal-pale);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.sec-badge {
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r-pill);
  padding: 4px 11px;
}

/* â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  position: relative;
  height: 420px;
  margin-bottom: 20px;
}

#map { width:100%; height:100%; }

.map-float {
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 900;
  background: rgba(255,255,255,.9);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px 16px;
  box-shadow: var(--shadow);
  pointer-events: none;
  min-width: 170px;
}

.map-float-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 4px;
}

.map-float-coords {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -.3px;
}

.map-float-name {
  font-size: 11px;
  color: var(--muted);
  margin-top: 3px;
}

/* Pulsing marker */
.pulse-dot {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--brand);
  border: 3px solid white;
  box-shadow: 0 2px 8px rgba(249,115,22,.55);
  position: relative;
}

.pulse-dot::after {
  content:'';
  position:absolute;
  inset:-8px;
  border-radius:50%;
  border: 2px solid rgba(249,115,22,.55);
  animation: map-ping 2s ease-out infinite;
}

@keyframes map-ping {
  0%   { transform:scale(1); opacity:.9; }
  100% { transform:scale(2.4); opacity:0; }
}

/* Leaflet overrides */
.leaflet-control-zoom a {
  color: var(--text2) !important;
  font-weight: 500;
}

.leaflet-control-attribution {
  font-size: 10px !important;
  background: rgba(255,255,255,.7) !important;
  backdrop-filter: blur(4px);
}

/* â”€â”€ ADVANCED SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.adv-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.adv-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 22px;
  cursor: pointer;
  user-select: none;
  transition: background .15s;
}

.adv-head:hover { background: #FAFBFC; }

.adv-head-l {
  display: flex;
  align-items: center;
  gap: 12px;
}

.adv-head-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: #F8FAFC;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.adv-head-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.1;
}

.adv-head-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 2px;
}

.adv-head-r {
  display: flex;
  align-items: center;
  gap: 10px;
}

.adv-tag {
  font-size: 11px;
  font-weight: 600;
  color: var(--brand);
  background: var(--brand-pale);
  border: 1px solid var(--brand-mid);
  border-radius: var(--r-pill);
  padding: 3px 10px;
}

.adv-chevron {
  width: 20px;
  height: 20px;
  color: var(--muted2);
  transition: transform .25s ease;
  flex-shrink: 0;
}

.adv-chevron.open { transform: rotate(180deg); }

.adv-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height .32s cubic-bezier(0.4,0,0.2,1);
}

.adv-body.open { max-height: 520px; }

.adv-inner {
  padding: 24px 22px 26px;
  border-top: 1px solid var(--border);
}

.adv-info {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 10px 14px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  margin-bottom: 20px;
  font-size: 12px;
  color: var(--text2);
  line-height: 1.5;
}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cfg-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.field { display: flex; flex-direction: column; gap: 6px; }

.field-lbl {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
}

.field-hint {
  font-size: 11px;
  color: var(--muted2);
  line-height: 1.4;
}

input[type="number"] {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 10px 13px;
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  font-weight: 500;
  outline: none;
  transition: border-color .16s, box-shadow .16s, background .16s;
  -moz-appearance: textfield;
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

input[type="number"]:hover:not(:focus) { border-color: var(--border2); }

input[type="number"]:focus {
  background: var(--card);
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(249,115,22,.12);
}

/* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.divider { height: 1px; background: var(--border); margin: 22px 0; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 13px 18px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  transform: translateY(90px);
  opacity: 0;
  transition: all .3s cubic-bezier(.34,1.56,.64,1);
  z-index: 9999;
  max-width: 380px;
  box-shadow: var(--shadow-lg);
}

.t-led { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

.toast.show { transform:translateY(0); opacity:1; }
.toast.success { border-color:#BBF7D0; }
.toast.success .t-led { background: var(--success); }
.toast.error   { border-color:#FECACA; }
.toast.error   .t-led { background: var(--danger);  }
.toast.warn    { border-color:#FDE68A; }
.toast.warn    .t-led { background: var(--warn);    }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 980px) {
  .metrics-grid { grid-template-columns: 1fr 1fr; }
  .cfg-grid     { grid-template-columns: 1fr 1fr; }
  .map-wrap     { height: 360px; }
}

@media (max-width: 700px) {
  .pill-bar           { display: none; }
  .mobile-collars     { display: flex !important; }
  .metrics-grid       { grid-template-columns: 1fr 1fr; }
  .map-wrap           { height: 300px; }
  .map-float          { padding: 10px 13px; min-width: 150px; }
  .map-float-coords   { font-size: 13px; }
}

@media (max-width: 480px) {
  .page          { padding: 18px 16px 64px; }
  .metrics-grid  { grid-template-columns: 1fr; }
  .cfg-grid      { grid-template-columns: 1fr; }
  .m-value       { font-size: 32px; }
  .pet-name      { font-size: 18px; }
  .pet-actions   { gap: 6px; }
  .btn           { padding: 7px 13px; font-size: 12px; }
}
</style>
</head>
<body>

<!-- â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="navbar">
  <div class="nav-inner">

    <a class="logo" href="#">
      <div class="logo-icon">ğŸ¾</div>
      <div class="logo-name">my<em>perro</em></div>
    </a>

    <!-- Pill collar selector -->
    <div class="pill-bar" id="pillBar"></div>

    <div class="nav-right">
      <div class="conn-pill">
        <span class="conn-led connecting" id="connLed"></span>
        <span id="connText">Connectingâ€¦</span>
      </div>
    </div>

  </div>
</nav>

<!-- â”€â”€ MOBILE COLLAR STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mobile-collars" id="mobileCollars" style="padding:10px 16px 0;"></div>

<!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="page">

  <!-- Pet Hero Bar -->
  <div class="pet-bar">
    <div class="pet-id">
      <div class="pet-avi" id="petAvi">ğŸ¶</div>
      <div>
        <div class="pet-name" id="petName">â€”</div>
        <div class="pet-meta">
          <span id="collarLbl">Loadingâ€¦</span>
          <span id="statusTag"></span>
        </div>
      </div>
    </div>
    <div class="pet-actions">
      <span class="sync-label" id="syncLabel">Last sync: â€”</span>
      <button class="btn btn-reset" id="resetBtn" onclick="confirmReset()">
        <svg width="13" height="13" viewBox="0 0 20 20" fill="none"><path d="M4 10a6 6 0 1 1 1.22 3.65" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 14V10H8" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Reset
      </button>
      <button class="btn btn-outline" onclick="refreshData()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6"/><path d="M2 11.5a10 10 0 0117.8-4.3M22 12.5a10 10 0 01-17.8 4.3"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- Metrics Grid -->
  <div class="metrics-grid">

    <!-- Steps -->
    <div class="m-card" id="stepsCard">
      <div class="m-icon-row">
        <div class="m-icon orange">ğŸ¾</div>
        <span class="offline-tag" id="offlineBadge" style="display:none">â— Offline</span>
      </div>
      <div class="m-label">Steps Today</div>
      <div class="m-value brand" id="metricSteps"><span class="skel"></span></div>
      <div class="m-sub" id="metricStepsSub">Loadingâ€¦</div>
    </div>

    <!-- Temperature -->
    <div class="m-card teal-line" id="tempCard">
      <div class="m-icon-row">
        <div class="m-icon teal">ğŸŒ¡ï¸</div>
      </div>
      <div class="m-label">Temperature</div>
      <div class="m-value teal" id="metricTemp"><span class="skel"></span></div>
      <div class="m-sub" id="metricTempSub">Loadingâ€¦</div>
    </div>

    <!-- Last Seen -->
    <div class="m-card">
      <div class="m-icon-row">
        <div class="m-icon slate">ğŸ•</div>
      </div>
      <div class="m-label">Last Seen</div>
      <div class="m-value sm" id="metricLastSeen"><span class="skel ls"></span></div>
      <div class="m-sub" id="metricLastSeenSub">Loadingâ€¦</div>
    </div>

    <!-- Distance -->
    <div class="m-card">
      <div class="m-icon-row">
        <div class="m-icon warm">ğŸ—ºï¸</div>
      </div>
      <div class="m-label">Distance Est.</div>
      <div class="m-value brand" id="metricDist"><span class="skel"></span></div>
      <div class="m-sub">Based on step count</div>
    </div>

  </div>

  <!-- Map Hero -->
  <div class="sec-hdr">
    <div class="sec-title">
      <div class="sec-icon">ğŸ“</div>
      Last Known Location
    </div>
    <span class="sec-badge" id="mapBadge">Awaiting GPS fix</span>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-float">
      <div class="map-float-label">Active Collar</div>
      <div class="map-float-coords" id="mapCoords">12.9329Â°N, 77.6342Â°E</div>
      <div class="map-float-name" id="mapName">Bengaluru, India</div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Advanced Settings -->
  <div class="adv-card">
    <div class="adv-head" onclick="toggleAdv()" role="button" aria-expanded="false" id="advHead">
      <div class="adv-head-l">
        <div class="adv-head-icon">âš™ï¸</div>
        <div>
          <div class="adv-head-title">Advanced Settings</div>
          <div class="adv-head-sub">Algorithm config &amp; sensor tuning</div>
        </div>
      </div>
      <div class="adv-head-r">
        <span class="adv-tag">Admin</span>
        <svg class="adv-chevron" id="advChevron" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 7.5l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div class="adv-body" id="advBody">
      <div class="adv-inner">

        <div class="adv-info">
          <svg width="15" height="15" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;margin-top:1px">
            <circle cx="10" cy="10" r="8.5" stroke="#94A3B8" stroke-width="1.5"/>
            <path d="M10 9v5M10 7v.5" stroke="#94A3B8" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          Changes push instantly to the collar via ThingsBoard MQTT. Use with care.
        </div>

        <div class="cfg-grid">
          <div class="field">
            <div class="field-lbl">Peak Threshold</div>
            <div class="field-hint">Min acceleration to count as step peak</div>
            <input type="number" id="cfgPeakThreshold" value="11.3" min="1" max="50" step="0.1"/>
          </div>
          <div class="field">
            <div class="field-lbl">Peak Window N</div>
            <div class="field-hint">Samples each side of peak</div>
            <input type="number" id="cfgPeakWindowN" value="4" min="1" max="10" step="1"/>
          </div>
          <div class="field">
            <div class="field-lbl">Filter Window</div>
            <div class="field-hint">Moving average smoothing size</div>
            <input type="number" id="cfgFilterWindow" value="5" min="1" max="20" step="1"/>
          </div>
          <div class="field">
            <div class="field-lbl">Emissivity</div>
            <div class="field-hint">MLX90614 sensor surface (0.1â€“1.0)</div>
            <input type="number" id="cfgEmissivity" value="0.95" min="0.1" max="1.0" step="0.01"/>
          </div>
        </div>

        <button class="btn btn-primary full" id="saveBtn" onclick="saveConfig()">
          Push Config to Collar
        </button>

      </div>
    </div>
  </div>

</main>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="t-led"></span>
  <span id="toastMsg"></span>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const OFFLINE_TIMEOUT = 30000;  // ms
const STEP_STRIDE_M   = 0.55;   // average dog stride â‰ˆ 55 cm

const COLLARS = [
  { name:"Collar 1", pet:"Buddy",   avi:"ğŸ¶", id:"8ffcb860-141c-11f1-ad13-23db93f4d850" },
  { name:"Collar 2", pet:"Charlie", avi:"ğŸ¦®", id:"bc1cde30-1425-11f1-ad13-23db93f4d850" },
  { name:"Collar 3", pet:"Luna",    avi:"ğŸ•", id:"cf525160-1425-11f1-9033-1744e78c8f53" },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let active         = 0;
let status         = COLLARS.map(() => ({ tsMs:null, online:false, steps:null, temp:null }));
let resetDone      = [false, false, false];
let mapInst        = null;
let mapMk          = null;
let confirmingReset = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API  â€” all calls proxied through /api/tb (credentials stay server-side)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function tbFetch(path, opts = {}) {
  const res = await fetch(`/api/tb?path=${encodeURIComponent(path)}`, {
    method:  opts.method || "GET",
    headers: { "Content-Type": "application/json" },
    ...(opts.body ? { body: JSON.stringify(opts.body) } : {}),
  });
  if (!res.ok) {
    const e = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
    throw new Error(e.error || `Request failed: ${res.status}`);
  }
  const txt = await res.text();
  return txt ? JSON.parse(txt) : null;
}

const getTelemetry = id =>
  tbFetch(`/api/plugins/telemetry/DEVICE/${id}/values/timeseries?keys=steps,temperature`);

const pushZero = async id => {
  const r = await fetch(`/api/tb?path=${encodeURIComponent(
    `/api/plugins/telemetry/DEVICE/${id}/timeseries/ANY`)}`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ steps:0, temperature:0 }),
  });
  return r.ok || r.status === 204;
};

const getAttrs = async id => {
  const a = await tbFetch(`/api/plugins/telemetry/DEVICE/${id}/values/attributes/SHARED_SCOPE`);
  return Object.fromEntries((a||[]).map(x => [x.key, x.value]));
};

const setAttrs = (id, attrs) =>
  tbFetch(`/api/plugins/telemetry/DEVICE/${id}/attributes/SHARED_SCOPE`, { method:"POST", body:attrs });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initMap() {
  if (mapInst) return;
  const center = [12.9329, 77.6342];
  mapInst = L.map('map', { zoomControl:false, attributionControl:true }).setView(center, 14);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© <a href="https://openstreetmap.org/copyright">OSM</a> Â© <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19,
  }).addTo(mapInst);

  L.control.zoom({ position:'bottomright' }).addTo(mapInst);

  const icon = L.divIcon({
    className: '',
    html: '<div class="pulse-dot"></div>',
    iconSize:   [18,18],
    iconAnchor: [9,9],
  });

  mapMk = L.marker(center, { icon }).addTo(mapInst);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET  (two-tap destructive pattern)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function confirmReset() {
  const btn = document.getElementById("resetBtn");
  if (!confirmingReset) {
    confirmingReset = true;
    btn.style.borderColor = "#FECACA";
    btn.style.background  = "#FEF2F2";
    btn.style.color       = "var(--danger)";
    btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 20 20" fill="none"><path d="M4 4 L16 16 M16 4 L4 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Confirm reset?`;
    clearTimeout(btn._ct);
    btn._ct = setTimeout(() => {
      if (confirmingReset) { confirmingReset = false; resetNeutral(); }
    }, 3500);
    return;
  }
  confirmingReset = false;
  btn.disabled    = true;
  btn.innerHTML   = "Resettingâ€¦";
  try {
    await pushZero(COLLARS[active].id);
    resetDone[active]       = true;
    status[active].steps    = 0;
    status[active].temp     = 0;
    render(active);
    showToast(`Reset ${COLLARS[active].pet}'s collar to zero`, "success");
  } catch (e) {
    showToast("Reset failed: " + e.message, "error");
  } finally {
    btn.disabled = false;
    resetNeutral();
  }
}

function resetNeutral() {
  const btn = document.getElementById("resetBtn");
  btn.style.borderColor = "";
  btn.style.background  = "";
  btn.style.color       = "";
  btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 20 20" fill="none"><path d="M4 10a6 6 0 1 1 1.22 3.65" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 14V10H8" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/></svg> Reset`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OFFLINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function handleOffline(i) {
  if (resetDone[i]) return;
  resetDone[i] = true;
  try {
    await pushZero(COLLARS[i].id);
    showToast(`${COLLARS[i].pet} went offline â€” values reset`, "warn");
    if (i === active) render(i);
  } catch (_) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refreshData() {
  setConn("connecting");
  try {
    const [telem, attrs] = await Promise.all([
      getTelemetry(COLLARS[active].id),
      getAttrs(COLLARS[active].id),
    ]);
    const steps  = telem.steps?.[0]?.value ?? null;
    const temp   = telem.temperature?.[0]?.value ?? null;
    const tsMs   = telem.steps?.[0]?.ts || telem.temperature?.[0]?.ts || null;
    const online = !!(tsMs && (Date.now() - tsMs) < OFFLINE_TIMEOUT);

    status[active] = { tsMs, online, steps, temp };

    if (tsMs && !online) handleOffline(active);
    if (online) resetDone[active] = false;

    render(active);
    populateCfg(attrs);
    buildPills();
    setConn("online");
    document.getElementById("syncLabel").textContent =
      "Last sync: " + new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
  } catch (e) {
    setConn("error");
    showToast(e.message, "error");
  }
}

function setConn(s) {
  document.getElementById("connLed").className = "conn-led " + s;
  document.getElementById("connText").textContent =
    { online:"Connected", error:"Error", connecting:"Connectingâ€¦" }[s] || s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(i) {
  if (i !== active) return;
  const { tsMs, online, steps, temp } = status[i];
  const c = COLLARS[i];

  // Pet hero
  document.getElementById("petAvi").textContent  = c.avi;
  document.getElementById("petName").textContent = c.pet;
  document.getElementById("collarLbl").textContent = c.name;

  const stTag = document.getElementById("statusTag");
  if (tsMs) {
    stTag.className   = "status-tag " + (online ? "online" : "offline");
    stTag.textContent = online ? "â— Online" : "â—‹ Offline";
  } else {
    stTag.className   = "";
    stTag.textContent = "";
  }

  // Map info
  document.getElementById("mapName").textContent  = c.pet + " Â· " + c.name;
  document.getElementById("mapBadge").textContent = online ? "Live" : (tsMs ? "Last known" : "Awaiting GPS fix");

  const sc = document.getElementById("stepsCard");
  const tc = document.getElementById("tempCard");
  const ob = document.getElementById("offlineBadge");
  const sv = document.getElementById("metricSteps");

  if (online) {
    sc.classList.remove("offline-card");
    tc.classList.remove("offline-card");
    ob.style.display = "none";
    sv.className = "m-value brand";
  } else if (tsMs) {
    sc.classList.add("offline-card");
    tc.classList.add("offline-card");
    ob.style.display = "inline-flex";
    sv.className = "m-value muted";
  }

  // Steps
  sv.innerHTML = steps !== null
    ? Number(steps).toLocaleString()
    : `<span style="font-size:20px;color:var(--muted2);">No data</span>`;

  // Temperature
  const tv = document.getElementById("metricTemp");
  tv.innerHTML = temp !== null
    ? `${parseFloat(temp).toFixed(1)}<span class="m-unit">Â°C</span>`
    : `<span style="font-size:20px;color:var(--muted2);">No data</span>`;

  // Last seen
  const lsv = document.getElementById("metricLastSeen");
  const lss = document.getElementById("metricLastSeenSub");
  if (tsMs) {
    lsv.textContent = timeAgo(tsMs);
    lss.textContent = new Date(tsMs).toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
  } else {
    lsv.innerHTML   = `<span style="font-size:18px;color:var(--muted2);">Waitingâ€¦</span>`;
    lss.textContent = "No signal yet";
  }

  // Distance
  const dv = document.getElementById("metricDist");
  if (steps !== null && Number(steps) > 0) {
    const km = (Number(steps) * STEP_STRIDE_M / 1000).toFixed(2);
    dv.innerHTML = `${km}<span class="m-unit"> km</span>`;
  } else {
    dv.innerHTML = `<span style="font-size:20px;color:var(--muted2);">â€”</span>`;
  }

  // Step / temp subs
  document.getElementById("metricStepsSub").textContent = tsMs
    ? (online ? `Updated ${timeAgo(tsMs)}` : `Offline Â· last seen ${timeAgo(tsMs)}`)
    : "Waiting for deviceâ€¦";
  document.getElementById("metricTempSub").textContent = tsMs
    ? (online ? `Updated ${timeAgo(tsMs)}` : `Offline Â· last seen ${timeAgo(tsMs)}`)
    : "Waiting for deviceâ€¦";
}

function populateCfg(a) {
  if (!a) return;
  if (a.peak_threshold     != null) document.getElementById("cfgPeakThreshold").value = a.peak_threshold;
  if (a.peak_window_n      != null) document.getElementById("cfgPeakWindowN").value    = a.peak_window_n;
  if (a.filter_window_size != null) document.getElementById("cfgFilterWindow").value   = a.filter_window_size;
  if (a.emissivity         != null) document.getElementById("cfgEmissivity").value     = a.emissivity;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function saveConfig() {
  const pt  = parseFloat(document.getElementById("cfgPeakThreshold").value);
  const pwn = parseInt(document.getElementById("cfgPeakWindowN").value);
  const fw  = parseInt(document.getElementById("cfgFilterWindow").value);
  const em  = parseFloat(document.getElementById("cfgEmissivity").value);

  if (isNaN(pt)  || pt  < 1   || pt  > 50)  { showToast("Peak threshold must be 1â€“50",   "error"); return; }
  if (isNaN(pwn) || pwn < 1   || pwn > 10)  { showToast("Peak window N must be 1â€“10",    "error"); return; }
  if (isNaN(fw)  || fw  < 1   || fw  > 20)  { showToast("Filter window must be 1â€“20",    "error"); return; }
  if (isNaN(em)  || em  < 0.1 || em  > 1.0) { showToast("Emissivity must be 0.10â€“1.00", "error"); return; }

  const btn = document.getElementById("saveBtn");
  btn.disabled    = true;
  btn.textContent = "Pushing configâ€¦";
  try {
    await setAttrs(COLLARS[active].id, { peak_threshold:pt, peak_window_n:pwn, filter_window_size:fw, emissivity:em });
    showToast(`Config pushed to ${COLLARS[active].pet}`, "success");
  } catch (e) {
    showToast(e.message, "error");
  } finally {
    btn.disabled    = false;
    btn.textContent = "Push Config to Collar";
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PILLS (navbar + mobile strip)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPills() {
  ["pillBar","mobileCollars"].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = "";
    COLLARS.forEach((c, i) => {
      const s = status[i];
      const p = document.createElement("div");
      p.className = "c-pill"
        + (i === active      ? " active"       : "")
        + (s.online          ? " online-pill"  : "")
        + (!s.online && s.tsMs ? " offline-pill" : "");
      p.innerHTML = `<span class="pill-emo">${c.avi}</span><span>${c.pet}</span><span class="pill-led"></span>`;
      p.onclick = () => selectCollar(i);
      el.appendChild(p);
    });
  });
}

function selectCollar(i) {
  active          = i;
  confirmingReset = false;
  resetNeutral();
  buildPills();

  // Clear to loading state
  ["metricSteps","metricTemp","metricDist"].forEach(id =>
    document.getElementById(id).innerHTML = `<span class="skel"></span>`);
  document.getElementById("metricLastSeen").innerHTML = `<span class="skel ls"></span>`;
  ["metricStepsSub","metricTempSub","metricLastSeenSub"].forEach(id =>
    document.getElementById(id).textContent = "Loadingâ€¦");
  document.getElementById("offlineBadge").style.display = "none";
  document.getElementById("stepsCard").classList.remove("offline-card");
  document.getElementById("tempCard").classList.remove("offline-card");
  document.getElementById("petAvi").textContent  = COLLARS[i].avi;
  document.getElementById("petName").textContent = COLLARS[i].pet;
  document.getElementById("statusTag").textContent = "";

  refreshData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADVANCED TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleAdv() {
  const body    = document.getElementById("advBody");
  const chevron = document.getElementById("advChevron");
  const head    = document.getElementById("advHead");
  const isOpen  = body.classList.contains("open");
  body.classList.toggle("open", !isOpen);
  chevron.classList.toggle("open", !isOpen);
  head.setAttribute("aria-expanded", String(!isOpen));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND POLL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pollAll() {
  for (let i = 0; i < COLLARS.length; i++) {
    if (i === active) continue;
    try {
      const t   = await getTelemetry(COLLARS[i].id);
      const tsMs = t.steps?.[0]?.ts || t.temperature?.[0]?.ts || null;
      const on   = !!(tsMs && (Date.now() - tsMs) < OFFLINE_TIMEOUT);
      status[i]  = { steps:t.steps?.[0]?.value??null, temp:t.temperature?.[0]?.value??null, tsMs, online:on };
      if (tsMs && !on) handleOffline(i);
      if (on) resetDone[i] = false;
    } catch (_) {}
  }
  buildPills();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 5)     return "just now";
  if (s < 60)    return `${s}s ago`;
  if (s < 3600)  return `${Math.floor(s/60)}m ago`;
  if (s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}

function showToast(msg, type) {
  const t    = document.getElementById("toast");
  const led  = t.querySelector(".t-led");
  document.getElementById("toastMsg").textContent = msg;
  t.className = "toast " + (type || "");
  t.classList.add("show");
  const cols = { success:"var(--success)", error:"var(--danger)", warn:"var(--warn)" };
  led.style.background = cols[type] || "var(--muted2)";
  clearTimeout(t._to);
  t._to = setTimeout(() => t.classList.remove("show"), 4400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
buildPills();
initMap();
refreshData();
setInterval(refreshData, 10000);
setInterval(pollAll,     15000);
</script>
</body>
</html>
