<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyPerro â€” Collar Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:        #030712;
    --surface:   #0f172a;
    --surface2:  #1e293b;
    --surface3:  #263248;
    --border:    #2d3f5c;
    --border2:   #3b4f6e;
    --accent:    #38bdf8;
    --accent-glow: rgba(56,189,248,0.18);
    --accent2:   #22d3ee;
    --accent3:   #10b981;
    --danger:    #f43f5e;
    --warn:      #f59e0b;
    --text:      #f1f5f9;
    --text2:     #cbd5e1;
    --muted:     #64748b;
    --muted2:    #475569;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(56,189,248,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(56,189,248,0.025) 1px, transparent 1px);
    background-size: 52px 52px;
    pointer-events: none;
    z-index: 0;
  }

  /* Top glow bar */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
    z-index: 10;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1120px;
    margin: 0 auto;
    padding: 36px 24px 64px;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 40px;
    padding-bottom: 28px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-icon {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--surface3), var(--surface2));
    border: 1px solid var(--border2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 0 20px rgba(56,189,248,0.12);
  }

  .logo-wordmark {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .logo-name {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    line-height: 1;
  }

  .logo-name span { color: var(--accent); }

  .logo-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: .12em;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 7px 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: .04em;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--muted2);
  }

  .status-dot.online  { background: var(--accent3); box-shadow: 0 0 8px var(--accent3); animation: blink 2s infinite; }
  .status-dot.error   { background: var(--danger);  box-shadow: 0 0 8px var(--danger);  }
  .status-dot.connecting { background: var(--warn); box-shadow: 0 0 8px var(--warn); animation: blink 1.2s infinite; }

  @keyframes blink { 0%,100%{ opacity:1 } 50%{ opacity:.35 } }

  /* â”€â”€ COLLAR TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: .14em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .collar-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 28px;
  }

  .collar-tab {
    flex: 1;
    padding: 14px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.18s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
    position: relative;
    overflow: hidden;
  }

  .collar-tab::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--accent-glow), transparent);
    opacity: 0;
    transition: opacity .18s;
  }

  .collar-tab:hover { border-color: var(--border2); background: var(--surface2); }
  .collar-tab:hover::before { opacity: .5; }

  .collar-tab.active {
    border-color: var(--accent);
    background: var(--surface2);
    box-shadow: 0 0 0 1px rgba(56,189,248,0.12), inset 0 0 24px rgba(56,189,248,0.06);
  }

  .collar-tab.active::before { opacity: 1; }

  .tab-name {
    font-size: 13px;
    font-weight: 600;
    position: relative;
  }

  .tab-status {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 5px;
    position: relative;
  }

  .tab-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--muted2);
    flex-shrink: 0;
  }

  .collar-tab.online .tab-dot  { background: var(--accent3); box-shadow: 0 0 5px var(--accent3); }
  .collar-tab.offline-tab .tab-dot { background: var(--danger); }

  /* â”€â”€ METRICS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .refresh-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .last-updated {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .refresh-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-sm {
    border-radius: 8px;
    padding: 7px 14px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.18s;
    border: 1px solid transparent;
  }

  .btn-ghost {
    background: var(--surface);
    border-color: var(--border);
    color: var(--text2);
  }

  .btn-ghost:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--surface2);
  }

  .btn-danger {
    background: rgba(244, 63, 94, 0.08);
    border-color: rgba(244, 63, 94, 0.25);
    color: var(--danger);
  }

  .btn-danger:hover {
    background: rgba(244, 63, 94, 0.15);
    border-color: var(--danger);
  }

  .btn-sm:disabled { opacity: .45; cursor: not-allowed; pointer-events: none; }

  /* â”€â”€ METRIC CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 20px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 26px;
    transition: border-color .18s, box-shadow .18s;
    position: relative;
    overflow: hidden;
  }

  .card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.3), transparent);
    opacity: 0;
    transition: opacity .2s;
  }

  .card:hover::after { opacity: 1; }

  .card.offline-card {
    border-color: rgba(244,63,94,0.3);
    background: rgba(244,63,94,0.03);
  }

  .card-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: .12em;
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-icon {
    width: 28px;
    height: 28px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .offline-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(244,63,94,0.1);
    border: 1px solid rgba(244,63,94,0.3);
    border-radius: 999px;
    padding: 2px 9px;
    font-size: 10px;
    color: var(--danger);
  }

  .card-value {
    font-size: 50px;
    font-weight: 800;
    letter-spacing: -2px;
    line-height: 1;
    color: var(--text);
  }

  .card-value.accent {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .card-value.dim {
    background: linear-gradient(135deg, var(--muted), var(--muted2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .card-unit {
    font-size: 18px;
    font-weight: 400;
    opacity: .55;
    margin-left: 3px;
    -webkit-text-fill-color: var(--muted);
    color: var(--muted);
  }

  .card-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    margin-top: 10px;
  }

  /* â”€â”€ CONFIG SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .config-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    position: relative;
    overflow: hidden;
  }

  .config-section::before {
    content: '';
    position: absolute;
    top: -1px; left: 20px; right: 20px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .config-header {
    margin-bottom: 24px;
  }

  .config-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .config-title-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
  }

  .config-subtitle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .config-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 7px;
  }

  .field label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: .08em;
    text-transform: uppercase;
  }

  .field-hint {
    font-size: 11px;
    color: var(--muted2);
    line-height: 1.4;
  }

  input[type="number"] {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 13px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color .18s, box-shadow .18s;
    -moz-appearance: textfield;
  }

  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

  input[type="number"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(56,189,248,.12);
  }

  input[type="number"]:hover:not(:focus) {
    border-color: var(--border2);
  }

  .btn-primary {
    margin-top: 24px;
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    color: #030712;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all .18s;
    position: relative;
    overflow: hidden;
    letter-spacing: .01em;
  }

  .btn-primary::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,.12);
    opacity: 0;
    transition: opacity .18s;
  }

  .btn-primary:hover::before  { opacity: 1; }
  .btn-primary:active          { transform: scale(.985); }
  .btn-primary:disabled        { opacity: .4; cursor: not-allowed; pointer-events: none; }

  /* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 28px 0;
  }

  /* â”€â”€ SKELETON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .skeleton {
    background: linear-gradient(90deg, var(--surface2) 25%, var(--surface3) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
    height: 50px;
    width: 130px;
    display: inline-block;
  }

  @keyframes shimmer { 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }

  /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    transform: translateY(90px);
    opacity: 0;
    transition: all .3s cubic-bezier(.34, 1.56, .64, 1);
    z-index: 200;
    max-width: 400px;
    box-shadow: 0 8px 32px rgba(0,0,0,.5);
    backdrop-filter: blur(8px);
  }

  .toast.show    { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: var(--accent3); color: var(--accent3); }
  .toast.error   { border-color: var(--danger);  color: var(--danger);  }
  .toast.warn    { border-color: var(--warn);    color: var(--warn);    }

  /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    .panel       { grid-template-columns: 1fr; }
    .config-grid-4 { grid-template-columns: 1fr 1fr; }
    .collar-tabs { flex-direction: column; }
    .header-right { gap: 8px; }
  }

  @media (max-width: 480px) {
    .app         { padding: 20px 16px 48px; }
    .config-grid-4 { grid-template-columns: 1fr; }
    .card-value  { font-size: 40px; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">ğŸ¾</div>
      <div class="logo-wordmark">
        <div class="logo-name">my<span>perro</span></div>
        <div class="logo-sub">Collar Dashboard</div>
      </div>
    </div>
    <div class="header-right">
      <div class="status-pill">
        <span class="status-dot connecting" id="connDot"></span>
        <span id="connLabel">connecting...</span>
      </div>
    </div>
  </header>

  <!-- COLLAR TABS -->
  <div class="section-label">Select Collar</div>
  <div class="collar-tabs" id="collarTabs"></div>

  <!-- REFRESH ROW -->
  <div class="refresh-row">
    <span class="last-updated" id="lastUpdated">â€”</span>
    <div class="refresh-right">
      <button class="btn-sm btn-danger" id="resetBtn" onclick="resetCollar()">âœ• reset to 0</button>
      <button class="btn-sm btn-ghost" onclick="refreshData()">â†» refresh</button>
    </div>
  </div>

  <!-- METRIC CARDS -->
  <div class="panel">
    <div class="card" id="stepsCard">
      <div class="card-label">
        Total Steps
        <span class="card-icon">ğŸ‘Ÿ</span>
      </div>
      <div class="card-value accent" id="metricSteps"><span class="skeleton"></span></div>
      <div class="card-sub" id="metricStepsSub">loading...</div>
      <span class="offline-badge" id="offlineBadge" style="display:none; margin-top:10px">â— offline</span>
    </div>
    <div class="card" id="tempCard">
      <div class="card-label">
        Temperature
        <span class="card-icon">ğŸŒ¡</span>
      </div>
      <div class="card-value" id="metricTemp"><span class="skeleton"></span></div>
      <div class="card-sub" id="metricTempSub">loading...</div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- CONFIG SECTION -->
  <div class="config-section">
    <div class="config-header">
      <div class="config-title">
        <span class="config-title-dot"></span>
        Algorithm Config
      </div>
      <div class="config-subtitle">Changes push instantly to collar via ThingsBoard MQTT</div>
    </div>
    <div class="config-grid-4">
      <div class="field">
        <label>Peak Threshold</label>
        <div class="field-hint">Min accel to count as peak</div>
        <input type="number" id="cfgPeakThreshold" value="11.3" min="1" max="50" step="0.1"/>
      </div>
      <div class="field">
        <label>Peak Window N</label>
        <div class="field-hint">Samples each side of peak</div>
        <input type="number" id="cfgPeakWindowN" value="4" min="1" max="10" step="1"/>
      </div>
      <div class="field">
        <label>Filter Window</label>
        <div class="field-hint">Moving avg smoothing size</div>
        <input type="number" id="cfgFilterWindow" value="5" min="1" max="20" step="1"/>
      </div>
      <div class="field">
        <label>Emissivity</label>
        <div class="field-hint">MLX90614 surface (0.1â€“1.0)</div>
        <input type="number" id="cfgEmissivity" value="0.95" min="0.1" max="1.0" step="0.01"/>
      </div>
    </div>
    <button class="btn-primary" id="saveBtn" onclick="saveConfig()">Push Config to Collar</button>
  </div>

</div>
<div class="toast" id="toast"></div>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OFFLINE_TIMEOUT = 30000; // ms â€” mark device offline if no data within this window

const COLLARS = [
  { name: "Collar 1", deviceId: "8ffcb860-141c-11f1-ad13-23db93f4d850" },
  { name: "Collar 2", deviceId: "bc1cde30-1425-11f1-ad13-23db93f4d850" },
  { name: "Collar 3", deviceId: "cf525160-1425-11f1-9033-1744e78c8f53" },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeCollar = 0;
let collarStatus = COLLARS.map(() => ({ tsMs: null, isOnline: false, steps: null, temp: null }));
let offlineResetDone = [false, false, false];

// â”€â”€ API Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * Proxy all ThingsBoard API calls through the Vercel serverless function.
 * Credentials (TB_HOST, TB_USER, TB_PASS) live only on the server.
 */
async function tbFetch(path, options = {}) {
  const proxyUrl = `/api/tb?path=${encodeURIComponent(path)}`;
  const res = await fetch(proxyUrl, {
    method: options.method || "GET",
    headers: { "Content-Type": "application/json" },
    ...(options.body ? { body: JSON.stringify(options.body) } : {}),
  });
  if (!res.ok) {
    const errData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
    throw new Error(errData.error || `Request failed with status ${res.status}`);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// â”€â”€ ThingsBoard API wrappers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getTelemetry(deviceId) {
  return tbFetch(
    `/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=steps,temperature`
  );
}

async function pushZero(deviceId) {
  const res = await fetch(`/api/tb?path=${encodeURIComponent(
    `/api/plugins/telemetry/DEVICE/${deviceId}/timeseries/ANY`
  )}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ steps: 0, temperature: 0 }),
  });
  return res.ok || res.status === 204;
}

async function getAttrs(deviceId) {
  const arr = await tbFetch(
    `/api/plugins/telemetry/DEVICE/${deviceId}/values/attributes/SHARED_SCOPE`
  );
  const obj = {};
  (arr || []).forEach(x => (obj[x.key] = x.value));
  return obj;
}

async function setAttrs(deviceId, attrs) {
  return tbFetch(
    `/api/plugins/telemetry/DEVICE/${deviceId}/attributes/SHARED_SCOPE`,
    { method: "POST", body: attrs }
  );
}

// â”€â”€ Offline handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleOffline(i) {
  if (offlineResetDone[i]) return;
  offlineResetDone[i] = true;
  try {
    await pushZero(COLLARS[i].deviceId);
    showToast(`âš  ${COLLARS[i].name} offline â€” values reset to 0`, "warn");
    if (i === activeCollar) renderMetrics(i);
  } catch (_) {}
}

async function resetCollar() {
  const btn = document.getElementById("resetBtn");
  btn.disabled = true;
  btn.textContent = "resetting...";
  try {
    await pushZero(COLLARS[activeCollar].deviceId);
    offlineResetDone[activeCollar] = true;
    collarStatus[activeCollar].steps = 0;
    collarStatus[activeCollar].temp  = 0;
    renderMetrics(activeCollar);
    showToast(`âœ“ ${COLLARS[activeCollar].name} reset to 0`, "success");
  } catch (e) {
    showToast("âœ— Reset failed: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "âœ• reset to 0";
  }
}

// â”€â”€ Data refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshData() {
  const collar = COLLARS[activeCollar];
  setConnState("connecting");
  try {
    const [telem, attrs] = await Promise.all([
      getTelemetry(collar.deviceId),
      getAttrs(collar.deviceId),
    ]);
    const steps = telem.steps?.[0]?.value ?? null;
    const temp  = telem.temperature?.[0]?.value ?? null;
    const tsMs  = telem.steps?.[0]?.ts || telem.temperature?.[0]?.ts || null;
    const isOnline = tsMs && (Date.now() - tsMs) < OFFLINE_TIMEOUT;

    collarStatus[activeCollar] = { steps, temp, tsMs, isOnline };

    if (tsMs && !isOnline) handleOffline(activeCollar);
    if (isOnline) offlineResetDone[activeCollar] = false;

    renderMetrics(activeCollar);
    populateConfig(attrs);
    updateTabStatus();
    setConnState("online");
    document.getElementById("lastUpdated").textContent =
      "refreshed " + new Date().toLocaleTimeString();
  } catch (e) {
    setConnState("error");
    showToast("âš  " + e.message, "error");
  }
}

function setConnState(state) {
  const dot   = document.getElementById("connDot");
  const label = document.getElementById("connLabel");
  dot.className = "status-dot " + state;
  const labels = { online: "connected", error: "error", connecting: "connecting..." };
  label.textContent = labels[state] || state;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMetrics(i) {
  if (i !== activeCollar) return;
  const { steps, temp, tsMs, isOnline } = collarStatus[i];
  const se = document.getElementById("metricSteps");
  const te = document.getElementById("metricTemp");
  const sc = document.getElementById("stepsCard");
  const tc = document.getElementById("tempCard");
  const b  = document.getElementById("offlineBadge");

  if (isOnline) {
    sc.classList.remove("offline-card");
    tc.classList.remove("offline-card");
    b.style.display = "none";
    se.className = "card-value accent";
  } else if (tsMs) {
    sc.classList.add("offline-card");
    tc.classList.add("offline-card");
    b.style.display = "inline-flex";
    se.className = "card-value dim";
  }

  se.innerHTML = steps !== null
    ? Number(steps).toLocaleString()
    : `<span style="font-size:22px;opacity:.35">no data</span>`;

  te.innerHTML = temp !== null
    ? `${parseFloat(temp).toFixed(1)}<span class="card-unit">Â°C</span>`
    : `<span style="font-size:22px;opacity:.35">no data</span>`;

  const ago = tsMs ? timeAgo(tsMs) : null;
  document.getElementById("metricStepsSub").textContent = tsMs
    ? (isOnline ? `updated ${ago}` : `last seen ${ago} â€” offline`)
    : "waiting for device...";
  document.getElementById("metricTempSub").textContent = tsMs
    ? (isOnline ? `updated ${ago}` : `last seen ${ago}`)
    : "waiting for device...";
}

function populateConfig(a) {
  if (!a) return;
  if (a.peak_threshold   != null) document.getElementById("cfgPeakThreshold").value = a.peak_threshold;
  if (a.peak_window_n    != null) document.getElementById("cfgPeakWindowN").value    = a.peak_window_n;
  if (a.filter_window_size != null) document.getElementById("cfgFilterWindow").value = a.filter_window_size;
  if (a.emissivity       != null) document.getElementById("cfgEmissivity").value      = a.emissivity;
}

// â”€â”€ Save config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveConfig() {
  const pt  = parseFloat(document.getElementById("cfgPeakThreshold").value);
  const pwn = parseInt(document.getElementById("cfgPeakWindowN").value);
  const fw  = parseInt(document.getElementById("cfgFilterWindow").value);
  const em  = parseFloat(document.getElementById("cfgEmissivity").value);

  if (isNaN(pt)  || pt  < 1   || pt  > 50)  { showToast("âœ— Peak threshold: enter 1â€“50",    "error"); return; }
  if (isNaN(pwn) || pwn < 1   || pwn > 10)  { showToast("âœ— Peak window N: enter 1â€“10",     "error"); return; }
  if (isNaN(fw)  || fw  < 1   || fw  > 20)  { showToast("âœ— Filter window: enter 1â€“20",     "error"); return; }
  if (isNaN(em)  || em  < 0.1 || em  > 1.0) { showToast("âœ— Emissivity: enter 0.10â€“1.00",  "error"); return; }

  const btn = document.getElementById("saveBtn");
  btn.disabled    = true;
  btn.textContent = "Pushing...";
  try {
    await setAttrs(COLLARS[activeCollar].deviceId, {
      peak_threshold:   pt,
      peak_window_n:    pwn,
      filter_window_size: fw,
      emissivity:       em,
    });
    showToast("âœ“ Config pushed to " + COLLARS[activeCollar].name, "success");
  } catch (e) {
    showToast("âœ— " + e.message, "error");
  } finally {
    btn.disabled    = false;
    btn.textContent = "Push Config to Collar";
  }
}

// â”€â”€ Tab management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabs() {
  const container = document.getElementById("collarTabs");
  container.innerHTML = "";
  COLLARS.forEach((collar, i) => {
    const s   = collarStatus[i];
    const tab = document.createElement("div");
    tab.className =
      "collar-tab" +
      (i === activeCollar    ? " active"      : "") +
      (s.isOnline             ? " online"      : "") +
      (!s.isOnline && s.tsMs  ? " offline-tab" : "");
    tab.innerHTML = `
      <div class="tab-name">${collar.name}</div>
      <div class="tab-status">
        <span class="tab-dot"></span>
        <span>${s.tsMs ? (s.isOnline ? "online" : "offline") : "â€”"}</span>
      </div>`;
    tab.onclick = () => selectCollar(i);
    container.appendChild(tab);
  });
}

function selectCollar(i) {
  activeCollar = i;
  buildTabs();
  document.getElementById("metricSteps").innerHTML   = '<span class="skeleton"></span>';
  document.getElementById("metricTemp").innerHTML    = '<span class="skeleton"></span>';
  document.getElementById("metricStepsSub").textContent = "loading...";
  document.getElementById("metricTempSub").textContent  = "loading...";
  document.getElementById("offlineBadge").style.display = "none";
  document.getElementById("stepsCard").classList.remove("offline-card");
  document.getElementById("tempCard").classList.remove("offline-card");
  refreshData();
}

function updateTabStatus() { buildTabs(); }

// â”€â”€ Background poll (non-active collars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollAllCollars() {
  for (let i = 0; i < COLLARS.length; i++) {
    if (i === activeCollar) continue;
    try {
      const telem = await getTelemetry(COLLARS[i].deviceId);
      const tsMs  = telem.steps?.[0]?.ts || telem.temperature?.[0]?.ts || null;
      const isOnline = tsMs && (Date.now() - tsMs) < OFFLINE_TIMEOUT;
      collarStatus[i] = {
        steps: telem.steps?.[0]?.value ?? null,
        temp:  telem.temperature?.[0]?.value ?? null,
        tsMs,
        isOnline,
      };
      if (tsMs && !isOnline) handleOffline(i);
      if (isOnline) offlineResetDone[i] = false;
    } catch (_) {}
  }
  updateTabStatus();
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 5)    return "just now";
  if (s < 60)   return s + "s ago";
  if (s < 3600) return Math.floor(s / 60) + "m ago";
  return Math.floor(s / 3600) + "h ago";
}

function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent  = msg;
  t.className    = "toast " + (type || "");
  t.classList.add("show");
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove("show"), 4000);
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildTabs();
refreshData();
setInterval(refreshData,    10000);
setInterval(pollAllCollars, 15000);
</script>
</body>
</html>
